<!--

This file is part of the yaosp build system

Copyright (c) 2009, 2010 Zoltan Kovacs
Copyright (c) 2009 Kornel Csernai

This program is free software; you can redistribute it and/or modify
it under the terms of version 2 of the GNU General Public License
as published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License along
with this program; if not, write to the Free Software Foundation, Inc.,
51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

-->

<build default="all">
    <array name="files_i386">
        <item>arch/i386/syscall.S</item>
        <item>arch/i386/getpagesize.c</item>
        <item>arch/i386/setjmp.S</item>
        <item>arch/i386/longjmp.S</item>
        <item>arch/i386/memcpy.S</item>
        <item>arch/i386/math/e_exp.S</item>
        <item>arch/i386/math/e_log.S</item>
        <item>arch/i386/math/s_sin.S</item>
        <item>arch/i386/math/s_cos.S</item>
        <item>arch/i386/math/s_floor.S</item>
        <item>arch/i386/math/s_ceil.S</item>
        <item>arch/i386/math/s_frexp.S</item>
        <item>arch/i386/math/s_fabs.S</item>
        <item>arch/i386/math/e_fmod.S</item>
        <item>arch/i386/math/e_atan2.S</item>
        <item>arch/i386/math/e_hypot.S</item>
        <item>arch/i386/math/e_pow.S</item>
        <item>arch/i386/math/s_finite.S</item>
        <item>arch/i386/math/s_scalbn.S</item>
        <item>arch/i386/math/e_log10.S</item>
        <item>arch/i386/math/s_tan.S</item>
        <item>arch/i386/math/s_atan.S</item>
        <item>arch/i386/math/e_sqrt.S</item>
    </array>

    <array name="files">
        <item>src/start.c</item>
        <item>src/opendir.c</item>
        <item>src/readdir.c</item>
        <item>src/closedir.c</item>
        <item>src/rewinddir.c</item>
        <item>src/stdlib/malloc.c</item>
        <item>src/stdlib/abort.c</item>
        <item>src/stdlib/getenv.c</item>
        <item>src/stdlib/strtol.c</item>
        <item>src/stdlib/strtoll.c</item>
        <item>src/stdlib/strtoul.c</item>
        <item>src/stdlib/strtoull.c</item>
        <item>src/stdlib/atoi.c</item>
        <item>src/stdlib/atol.c</item>
        <item>src/stdlib/atoll.c</item>
        <item>src/stdlib/atof.c</item>
        <item>src/stdlib/qsort.c</item>
        <item>src/stdlib/bsearch.c</item>
        <item>src/stdlib/abs.c</item>
        <item>src/stdlib/labs.c</item>
        <item>src/stdlib/llabs.c</item>
        <item>src/stdlib/strtod.c</item>
        <item>src/stdlib/mkstemp.c</item>
        <item>src/stdlib/random.c</item>
        <item>src/stdlib/srandom.c</item>
        <item>src/stdlib/rand.c</item>
        <item>src/stdlib/srand.c</item>
        <item>src/stdlib/mktemp.c</item>
        <item>src/stdlib/system.c</item>
        <item>src/string/memset.c</item>
        <item>src/string/memcpy.c</item>
        <item>src/string/memcmp.c</item>
        <item>src/string/memmove.c</item>
        <item>src/string/memchr.c</item>
        <item>src/string/strchr.c</item>
        <item>src/string/strrchr.c</item>
        <item>src/string/strlen.c</item>
        <item>src/string/strnlen.c</item>
        <item>src/string/strcmp.c</item>
        <item>src/string/strncmp.c</item>
        <item>src/string/strcasecmp.c</item>
        <item>src/string/strncasecmp.c</item>
        <item>src/string/strdup.c</item>
        <item>src/string/strndup.c</item>
        <item>src/string/strcpy.c</item>
        <item>src/string/strncpy.c</item>
        <item>src/string/strstr.c</item>
        <item>src/string/strerror.c</item>
        <item>src/string/strsignal.c</item>
        <item>src/string/strcat.c</item>
        <item>src/string/strncat.c</item>
        <item>src/string/strpbrk.c</item>
        <item>src/string/strspn.c</item>
        <item>src/string/strcspn.c</item>
        <item>src/string/strtok_r.c</item>
        <item>src/string/strtok.c</item>
        <item>src/unistd/sync.c</item>
        <item>src/unistd/sbrk.c</item>
        <item>src/unistd/fork.c</item>
        <item>src/unistd/execve.c</item>
        <item>src/unistd/execv.c</item>
        <item>src/unistd/execl.c</item>
        <item>src/unistd/execlp.c</item>
        <item>src/unistd/dup.c</item>
        <item>src/unistd/dup2.c</item>
        <item>src/unistd/write.c</item>
        <item>src/unistd/read.c</item>
        <item>src/unistd/pwrite.c</item>
        <item>src/unistd/pread.c</item>
        <item>src/unistd/exit.c</item>
        <item>src/unistd/getdents.c</item>
        <item>src/unistd/close.c</item>
        <item>src/unistd/execvp.c</item>
        <item>src/unistd/fchdir.c</item>
        <item>src/unistd/isatty.c</item>
        <item>src/unistd/lseek.c</item>
        <item>src/unistd/unlink.c</item>
        <item>src/unistd/readlink.c</item>
        <item>src/unistd/getcwd.c</item>
        <item>src/unistd/sleep.c</item>
        <item>src/unistd/access.c</item>
        <item>src/unistd/chdir.c</item>
        <item>src/unistd/ftruncate.c</item>
        <item>src/unistd/getpid.c</item>
        <item>src/unistd/getppid.c</item>
        <item>src/unistd/gettid.c</item>
        <item>src/unistd/link.c</item>
        <item>src/unistd/rmdir.c</item>
        <item>src/unistd/chown.c</item>
        <item>src/unistd/symlink.c</item>
        <item>src/unistd/ttyname.c</item>
        <item>src/unistd/pipe.c</item>
        <item>src/unistd/alarm.c</item>
        <item>src/unistd/fpathconf.c</item>
        <item>src/unistd/getuid.c</item>
        <item>src/unistd/geteuid.c</item>
        <item>src/unistd/setuid.c</item>
        <item>src/unistd/setreuid.c</item>
        <item>src/unistd/getgid.c</item>
        <item>src/unistd/getegid.c</item>
        <item>src/unistd/setgid.c</item>
        <item>src/unistd/setregid.c</item>
        <item>src/unistd/gethostname.c</item>
        <item>src/unistd/getdtablesize.c</item>
        <item>src/unistd/getpgid.c</item>
        <item>src/unistd/setpgid.c</item>
        <item>src/unistd/getpgrp.c</item>
        <item>src/unistd/setpgrp.c</item>
        <item>src/unistd/usleep.c</item>
        <item>src/fcntl/open.c</item>
        <item>src/fcntl/creat.c</item>
        <item>src/fcntl/fcntl.c</item>
        <item>src/stdio/stdio_internal.c</item>
        <item>src/stdio/streams.c</item>
        <item>src/stdio/ferror.c</item>
        <item>src/stdio/fgetc.c</item>
        <item>src/stdio/getc.c</item>
        <item>src/stdio/fgets.c</item>
        <item>src/stdio/fputc.c</item>
        <item>src/stdio/fputs.c</item>
        <item>src/stdio/fileno.c</item>
        <item>src/stdio/feof.c</item>
        <item>src/stdio/fflush.c</item>
        <item>src/stdio/ungetc.c</item>
        <item>src/stdio/clearerr.c</item>
        <item>src/stdio/fopen.c</item>
        <item>src/stdio/fdopen.c</item>
        <item>src/stdio/freopen.c</item>
        <item>src/stdio/fclose.c</item>
        <item>src/stdio/popen.c</item>
        <item>src/stdio/pclose.c</item>
        <item>src/stdio/putc.c</item>
        <item>src/stdio/setvbuf.c</item>
        <item>src/stdio/fseek.c</item>
        <item>src/stdio/ftell.c</item>
        <item>src/stdio/fread.c</item>
        <item>src/stdio/fwrite.c</item>
        <item>src/stdio/rewind.c</item>
        <item>src/stdio/perror.c</item>
        <item>src/stdio/puts.c</item>
        <item>src/stdio/putchar.c</item>
        <item>src/stdio/rename.c</item>
        <item>src/stdio/remove.c</item>
        <item>src/stdio/fpurge.c</item>
        <item>src/time/tzset.c</item>
        <item>src/time/time_int.c</item>
        <item>src/time/strftime.c</item>
        <item>src/time/mktime.c</item>
        <item>src/time/ctime.c</item>
        <item>src/time/ctime_r.c</item>
        <item>src/time/localtime.c</item>
        <item>src/time/localtime_r.c</item>
        <item>src/time/asctime.c</item>
        <item>src/time/asctime_r.c</item>
        <item>src/time/gmtime.c</item>
        <item>src/time/gmtime_r.c</item>
        <item>src/time/gettimeofday.c</item>
        <item>src/time/ctime.c</item>
        <item>src/time/time.c</item>
        <item>src/time/nanosleep.c</item>
        <item>src/getopt/getopt.c</item>
        <item>src/getopt/getopt_long.c</item>
        <item>src/getopt/getopt_long_only.c</item>
        <item>src/sys/stat.c</item>
        <item>src/sys/fstat.c</item>
        <item>src/sys/stime.c</item>
        <item>src/sys/mkdir.c</item>
        <item>src/sys/ioctl.c</item>
        <item>src/sys/select.c</item>
        <item>src/sys/mount.c</item>
        <item>src/sys/umount.c</item>
        <item>src/sys/lstat.c</item>
        <item>src/sys/umask.c</item>
        <item>src/sys/chmod.c</item>
        <item>src/sys/utime.c</item>
        <item>src/sys/utimes.c</item>
        <item>src/sys/wait.c</item>
        <item>src/sys/wait3.c</item>
        <item>src/sys/wait4.c</item>
        <item>src/sys/waitpid.c</item>
        <item>src/sys/socket.c</item>
        <item>src/sys/connect.c</item>
        <item>src/sys/bind.c</item>
        <item>src/sys/listen.c</item>
        <item>src/sys/accept.c</item>
        <item>src/sys/recv.c</item>
        <item>src/sys/recvfrom.c</item>
        <item>src/sys/recvmsg.c</item>
        <item>src/sys/send.c</item>
        <item>src/sys/sendto.c</item>
        <item>src/sys/sendmsg.c</item>
        <item>src/sys/getsockopt.c</item>
        <item>src/sys/setsockopt.c</item>
        <item>src/sys/getsockname.c</item>
        <item>src/sys/getpeername.c</item>
        <item>src/sys/getrusage.c</item>
        <item>src/ctype/isalpha.c</item>
        <item>src/ctype/isupper.c</item>
        <item>src/ctype/isblank.c</item>
        <item>src/ctype/islower.c</item>
        <item>src/ctype/isdigit.c</item>
        <item>src/ctype/isxdigit.c</item>
        <item>src/ctype/isalnum.c</item>
        <item>src/ctype/isspace.c</item>
        <item>src/ctype/isprint.c</item>
        <item>src/ctype/iscntrl.c</item>
        <item>src/ctype/tolower.c</item>
        <item>src/ctype/toupper.c</item>
        <item>src/ctype/toascii.c</item>
        <item>src/ctype/isgraph.c</item>
        <item>src/ctype/ispunct.c</item>
        <item>src/ctype/isascii.c</item>
        <item>src/signal/signal.c</item>
        <item>src/signal/sigaction.c</item>
        <item>src/signal/kill.c</item>
        <item>src/signal/killpg.c</item>
        <item>src/signal/raise.c</item>
        <item>src/signal/sigemptyset.c</item>
        <item>src/signal/sigfillset.c</item>
        <item>src/signal/sigaddset.c</item>
        <item>src/signal/sigdelset.c</item>
        <item>src/signal/sigismember.c</item>
        <item>src/signal/sigprocmask.c</item>
        <item>src/signal/sigsetjmp.c</item>
        <item>src/signal/siglongjmp.c</item>
        <item>src/locale/localeconv.c</item>
        <item>src/locale/setlocale.c</item>
        <item>src/termios/tcflush.c</item>
        <item>src/termios/tcgetattr.c</item>
        <item>src/termios/tcsetattr.c</item>
        <item>src/termios/tcflow.c</item>
        <item>src/termios/tcgetpgrp.c</item>
        <item>src/termios/tcsetpgrp.c</item>
        <item>src/math/s_ldexp.c</item>
        <item>src/math/s_modf.c</item>
        <item>src/yaosp/debug.c</item>
        <item>src/yaosp/sysinfo.c</item>
        <item>src/yaosp/region.c</item>
        <item>src/yaosp/module.c</item>
        <item>src/yaosp/yaosp.c</item>
        <item>src/yaosp/ipc.c</item>
        <item>src/yaosp/config.c</item>
        <item>src/trio/trio.c</item>
        <item>src/trio/trionan.c</item>
        <item>src/trio/triostr.c</item>
        <item>src/pwd/getpwuid.c</item>
        <item>src/pwd/getpwent.c</item>
        <item>src/pwd/getpwnam.c</item>
        <item>src/pwd/endpwent.c</item>
        <item>src/pwd/setpwent.c</item>
        <item>src/network/inet_aton.c</item>
        <item>src/network/inet_pton.c</item>
        <item>src/network/inet_ntoa.c</item>
        <item>src/network/inet_ntop.c</item>
        <item>src/network/gethostbyname.c</item>
        <item>src/network/dns.c</item>
        <item>src/pthread/mutex.c</item>
        <item>src/pthread/mutexattr.c</item>
        <item>src/pthread/thread.c</item>
        <item>src/pthread/attr.c</item>
        <item>src/pthread/condition.c</item>
        <item>src/regex/collate.c</item>
        <item>src/regex/collcmp.c</item>
        <item>src/regex/regcomp.c</item>
        <item>src/regex/regerror.c</item>
        <item>src/regex/regexec.c</item>
        <item>src/regex/regfree.c</item>
    </array>

    <target name="clean">
        <delete>objs/arch/*</delete>
        <rmdir>objs/arch</rmdir>
        <delete>objs/*</delete>
        <rmdir>objs</rmdir>
    </target>

    <target name="prepare" type="private">
        <mkdir>objs</mkdir>
        <mkdir>objs/arch</mkdir>
    </target>

    <target name="compile">
        <call target="prepare"/>

        <echo/>
        <echo>Compiling C library</echo>
        <echo/>

        <for var="i" array="${files_i386}">
            <echo>[GCC    ] source/lib/c/${i}</echo>
            <gcc>
                <input>${i}</input>
                <output>objs/arch/filename(${i}).o</output>
                <flag>-c</flag>
                <flag>-O2</flag>
                <flag>-Wall</flag>
            </gcc>
        </for>

        <for var="i" array="${files}">
            <echo>[GCC    ] source/lib/c/${i}</echo>
            <gcc>
                <input>${i}</input>
                <output>objs/filename(${i}).o</output>
                <flag>-c</flag>
                <flag>-O2</flag>
                <flag>-Wall</flag>
                <define key="HAVE_MMAP">0</define>
                <define key="USE_LOCKS">1</define>
                <define key="YAOSP"/>
                <define key="TRIO_FEATURE_LOCALE">0</define>
                <define key="TRIO_PLATFORM_UNIX"/>
            </gcc>
        </for>

        <echo/>
        <echo>Linking C library</echo>
        <echo/>
        <echo>[AR     ] source/lib/c/objs/libc.a</echo>

        <ar>
            <flag>-rc</flag>
            <output>objs/libc.a</output>
            <input>objs/*.o</input>
            <input>objs/arch/*.o</input>
        </ar>
    </target>

    <target name="install">
        <copy from="objs/libc.a" to="../../../build/crosscompiler/lib/gcc/i686-pc-yaosp/4.3.3/libc.a"/>
    </target>

    <target name="all">
        <call target="clean"/>
        <call target="compile"/>
        <call target="install"/>
    </target>
</build>
